<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nh√† h√†ng g·∫ßn b·∫°n</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 500px;
        }
    </style>
</head>

<body>

    <div class="container my-4">
        <h2 class="mb-4">üè† Nh√† h√†ng g·∫ßn b·∫°n</h2>

        <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">T√¨m ƒë∆∞·ªùng ƒë·∫øn nh√† h√†ng:</label>
            <div class="col-sm-6">
                <input type="text" class="form-control" id="to" placeholder="Nh·∫≠p t√™n nh√† h√†ng ho·∫∑c ƒë·ªãa ch·ªâ">
            </div>
            <div class="col-sm-3">
                <button class="btn btn-primary w-100" onclick="findRoute()">Ch·ªâ ƒë∆∞·ªùng</button>
            </div>
        </div>
    </div>

    <div id="map" class="mb-4"></div>

    <div class="container">
        <ul id="restaurant-list" class="list-group mb-3"></ul>
        <div id="info" class="alert alert-info" role="alert" style="display: none;"></div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let userLat, userLon;
        let map;
        let routeLine;

        const apiKey = "5b3ce3597851110001cf624837f237df11b94468a2914dfa163ddf4f";

        function initMap(lat, lon) {
            map = L.map('map').setView([lat, lon], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker([lat, lon]).addTo(map).bindPopup("üìç V·ªã tr√≠ c·ªßa b·∫°n").openPopup();
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                userLat = position.coords.latitude;
                userLon = position.coords.longitude;

                initMap(userLat, userLon);

                // G·ªçi API t·ª´ server ƒë·ªÉ l·∫•y danh s√°ch nh√† h√†ng g·∫ßn ƒë√≥
                fetch(`/restaurants/nearby?lat=${userLat}&lon=${userLon}`)
                    .then(res => res.json())
                    .then(data => {
                        const list = document.getElementById("restaurant-list");
                        const info = document.getElementById("info");
                        list.innerHTML = "";
                        info.innerHTML = "";
                        info.style.display = "block";

                        if (data.length === 0) {
                            info.className = "alert alert-warning";
                            info.innerText = "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y nh√† h√†ng n√†o g·∫ßn b·∫°n.";
                            return;
                        }

                        info.className = "alert alert-info";
                        info.innerText = `üîç T√¨m th·∫•y ${data.length} nh√† h√†ng g·∫ßn b·∫°n.`;

                        data.forEach(r => {
                            L.marker([r.Latitude, r.Longitude])
                                .addTo(map)
                                .bindPopup(`<b>${r.name}</b><br>${r.Address} - ${r.Ward} - ${r.District} - ${r.City}`);

                            const item = document.createElement("li");
                            item.className = "list-group-item";
                            item.innerText = `${r.name} - ${r.distance.toFixed(2)} km`;
                            list.appendChild(item);
                        });
                    })
                    .catch(err => {
                        console.error(err);
                        alert("L·ªói khi t·∫£i danh s√°ch nh√† h√†ng.");
                    });
            });
        } else {
            alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.");
        }

        async function geocode(address) {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json`;
            const res = await fetch(url);
            const data = await res.json();
            if (data && data.length > 0) {
                return [parseFloat(data[0].lon), parseFloat(data[0].lat)];
            }
            throw new Error("Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô cho ƒë·ªãa ch·ªâ: " + address);
        }

        async function findRoute() {
            const toAddress = document.getElementById("to").value;
            if (!toAddress) {
                alert("‚ùå Vui l√≤ng nh·∫≠p t√™n nh√† h√†ng ho·∫∑c ƒë·ªãa ch·ªâ.");
                return;
            }

            try {
                const fromCoord = [userLon, userLat];
                const toCoord = await geocode(toAddress);

                const url = `https://api.openrouteservice.org/v2/directions/driving-car/geojson`;
                const res = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Authorization": apiKey,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ coordinates: [fromCoord, toCoord] })
                });

                const result = await res.json();
                const route = result.features?.[0];
                if (!route) throw new Error("Kh√¥ng t√¨m th·∫•y tuy·∫øn ƒë∆∞·ªùng.");

                const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
                if (routeLine) map.removeLayer(routeLine);
                routeLine = L.polyline(coords, { color: 'blue' }).addTo(map);
                map.fitBounds(routeLine.getBounds());

                const distanceKm = route.properties.summary.distance / 1000;
                const durationMin = route.properties.summary.duration / 60;
                const info = document.getElementById("info");
                info.style.display = "block";
                info.className = "alert alert-success";
                info.innerText = `üìè Kho·∫£ng c√°ch: ${distanceKm.toFixed(2)} km ‚Äì ‚è±Ô∏è Th·ªùi gian: ${durationMin.toFixed(1)} ph√∫t`;

            } catch (err) {
                console.error(err);
                alert("‚ùå " + err.message);
            }
        }
    </script>
</body>

</html>
